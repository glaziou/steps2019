--- 
title: "Enquête STEP 2019, Polynésie Française"
subtitle: "Steps 2 et 3, mesures anthropométriques et biologiques"
output:  
  html_document: 
    mode: selfcontained
    toc: yes 
    toc_float: true
    number_sections: false
    theme: flatly
fig_width: 12 
fig_caption: FALSE 
lang: fr
--- 


```{r setup, include=FALSE} 
# Chapter 1
# Set options, load data, utility functions 
knitr::opts_chunk$set(
  echo = FALSE,
  results = "asis",
  message = FALSE,
  warning = FALSE
)
library(data.table)
library(here)
library(survey)
library(knitr)
library(kableExtra)
library(gtsummary)
library(flextable)
library(labelled)

load(here('data/report.Rdata'))

theme_gtsummary_language('fr')
theme_gtsummary_journal('jama')

labelled::var_label(steps$bmigr) <- "Corpulence [IMC]"

``` 

Les mesures anthropométriques incluent:

* l'indice de masse corporelle
* le périmètre abdominal
* la tension artérielle

Les mesures biologiques incluent:

* la glycémie à jeun

Les tableaux suivants montrent ces indicateurs ajustés pour prendre en compte les effets d'échantillonage (pondération et stratification).


## 2.1 Corpulence

### Tableau 2.1.1 Corpulence

```{r tab_2_1_1}
survey::svydesign(id = ~ uid,
                  weights = ~ w2,
                  strata = ~gstratum + agegr,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr), .(uid,
                                                  w2,
                                                  gstratum,
                                                  agegr,
                                                  bmigr)]) |>
  
  tbl_svysummary(include = c(bmigr),
                 statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Pourcentage (IC 95%)**") |>
  bold_labels()

```



### Tableau 2.1.2 Corpulence par sexe

```{r tab_2_1_2}

survey::svydesign(id = ~ uid,
                  weights = ~ w2,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr), .(
                                   uid,
                                   w2,
                                   gstratum,
                                   Sexe=sexe,
                                   Age=agegr,
                                   bmigr
                                 )]) |>
  tbl_svysummary(include = c(bmigr),
                 by = Sexe,
                 statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Sexe**",
                stat_1 = "**Femmes**",
                stat_2 = "**Hommes**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() 

```




### Tableau 2.2.3 Corpulence par groupe d'âge (hommes et femmes)

```{r tab_2_1_3}
survey::svydesign(id = ~ uid,
                  weights = ~ w2,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr), .(
                                   uid,
                                   w2,
                                   gstratum,
                                   Sexe=sexe,
                                   Age=agegr,
                                   bmigr
                                 )]) |>
  tbl_svysummary(include = c(bmigr),
                 by = Age,
                 statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Groupe d'âge**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels() 

```

### Tableau 2.1.4 Corpulence par groupe d'âge (hommes)

```{r tab_2_1_4}
survey::svydesign(id = ~ uid,
                  weights = ~ w2,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr) & sex == "M" , .(uid,
                                                                w2,
                                                                gstratum,
                                                                Age = agegr,
                                                                bmigr)]) |>
  tbl_svysummary(
    include = c(bmigr),
    by = Age,
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Groupe d'âge**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels() 

```

### Tableau 2.1.5 Corpulence par groupe d'âge (femmes)

```{r tab_2_1_5}
survey::svydesign(id = ~ uid,
                  weights = ~ w2, strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr) & sex == "F", .(uid,
                                                               w2,
                                                               gstratum,
                                                               Age = agegr,
                                                               bmigr)]) |>
  tbl_svysummary(
    include = c(bmigr),
    by = Age,
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Groupe d'âge**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels()

```



### Tableau 2.1.6a Prévalence du surpoids

```{r tab_2_1_6a}
d <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + agegr,
  data = steps[enroll == 1 &
                 !is.na(bmigr), .(uid,
                                  w2,
                                  gstratum,
                                  agegr,
                                  bmigr,
                                  overweight,
                                  sexe,
                                  Surpoids)]
) 

tbl_svysummary(d,
               include = c(Surpoids),
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Prévalence (IC 95%)**") |>
  bold_labels()

```

### Tableau 2.1.6b Prévalence du surpoids par âge et sexe

```{r tab_2_1_6b}
tab <- svyby(~overweight, ~agegr+sexe, d, svymean, vartype=c("ci"))
tab[, 3:5] <- round(tab[, 3:5] * 100)
names(tab) <- c('Age','Sexe','Surpoids','lo','hi')
tab$gros <- paste0(tab$Surpoids, ' (', tab$lo, ' - ', tab$hi, ')')
names(tab)[6] <- "Surpoids (IC 95%)"
rownames(tab) <- NULL
tab <- tab[,c(1:2,6)]
gt::gt(tab, groupname_col = 'Sexe') |> 
 gt::tab_style(
     locations = cells_column_labels(columns = everything()),
     style     = list(
       cell_text(weight = "bold")
     )
   )

```



### Tableau 2.1.7a Prévalence de l'obésité

```{r tab_2_1_7a}
d <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + agegr,
  data = steps[enroll == 1 &
                 !is.na(bmigr), .(uid,
                                  w2,
                                  gstratum,
                                  agegr,
                                  bmigr,
                                  sexe,
                                  obese,
                                  Obese)]
)
tbl_svysummary(
  d,
  include = c(Obese),
  label = list(Obese ~ "Obésité"),
  statistic = list(all_categorical() ~ "{p}")
) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Prévalence (IC 95%)**") |>
  bold_labels()

```


### Tableau 2.1.7b Prévalence de l'obésité par âge et sexe

```{r tab_2_1_7b}
tab <- svyby( ~ obese, ~ agegr + sexe, d, svymean, vartype = c("ci"))
tab[, 3:5] <- round(tab[, 3:5] * 100)
names(tab) <- c('Age', 'Sexe', 'obese', 'lo', 'hi')
tab$gros <- paste0(tab$obese, ' (', tab$lo, ' - ', tab$hi, ')')
names(tab)[6] <- "Obésité (IC95%)"
rownames(tab) <- NULL
tab <- tab[, c(1:2, 6)]
gt::gt(tab, groupname_col = 'Sexe') |> 
 gt::tab_style(
     locations = cells_column_labels(columns = everything()),
     style     = list(
       cell_text(weight = "bold")
     )
   )


```





### Tableau 2.1.8 Obésité abdominale

```{r tab_2_1_8}
tf <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + Age,
  data = steps[enroll == 1 &
                 !is.na(bmigr) & sex == "F", .(uid,
                                               w2,
                                               gstratum,
                                               Age = agegr,
                                               bmigr,
                                               sexe,
                                               grosbide)]
) |>
  tbl_svysummary(
    include = c(bmigr),
    by = grosbide,
    label = grosbide ~ 'Obésité abdominale',
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Obésité abdominale**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels()

tm <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + Age,
  data = steps[enroll == 1 &
                 !is.na(bmigr) & sex == "M", .(uid,
                                               w2,
                                               gstratum,
                                               Age = agegr,
                                               bmigr,
                                               sex,
                                               sexe,
                                               grosbide)]
) |>
  tbl_svysummary(
    include = c(bmigr),
    by = grosbide,
    label = grosbide ~ 'Obésité abdominale',
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Obésité abdominale**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels()

tt <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + Age,
  data = steps[enroll == 1 &
                 !is.na(bmigr), .(uid,
                                  w2,
                                  gstratum,
                                  Age = agegr,
                                  bmigr,
                                  sexe,
                                  grosbide)]
) |>
  tbl_svysummary(
    include = c(bmigr),
    by = grosbide,
    label = grosbide ~ 'Obésité abdominale',
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Obésité abdominale**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels()

tbl_merge(
    tbls        = list(tf, tm, tt),
    tab_spanner = c("**Femmes**", "**Hommes**", "**Total**")
)


```



### Tableau 2.1.9 Facteurs de risque d'obésité (analyse uni- et multivariée, ajustées pour les effets d'échantillonnage)

```{r tab_2_1_9}
d <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + Age,
  data = steps[enroll == 1 &
                 !is.na(hta), .(uid,
                                  w2,
                                  gstratum,
                                  Sexe = sexe,
                                  Age = agegr,
                                  hta,
                                  HTA)]
)

# svymean(~hta, d, deff=T)

m1 <-
  svyglm(HTA ~ Sexe -1,
         design = d,
         family = "quasibinomial")
m2 <-
  svyglm(HTA ~ Age -1,
         design = d,
         family = "quasibinomial")
t1 <- tbl_regression(m1,
                     exponentiate = TRUE) |>
  modify_header(update = list(estimate ~ "**Prevalence (IC 95%)**")) |>
  modify_footnote(everything() ~ NA, abbreviation = TRUE) |>
  modify_column_hide(columns = p.value) |>
  bold_labels()
  

t2 <- tbl_regression(m2,
                     exponentiate = TRUE) |>
  modify_header(update = list(estimate ~ "**Prevalence (IC 95%)**")) |>
  modify_footnote(everything() ~ NA, abbreviation = TRUE) |>
  modify_column_hide(columns = p.value) |>
  bold_labels()

tbl_stack(tbls = list(t1, t2))

```



## 2.2 Hypertension artérielle

### Tableau 2.2.1a Prévalence de l'hypertension artérielle (HTA)
```{r tab_2_2_1a}
d <- survey::svydesign(
  id = ~ uid,
  weights = ~ w2,
  strata = ~ gstratum + agegr,
  data = steps[enroll == 1 &
                 !is.na(hta), .(uid,
                                  w2,
                                  gstratum,
                                  agegr,
                                  sexe,
                                  hta,
                                  HTA)]
)

tbl_svysummary(d,
               include = c(HTA),
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Prévalence (IC 95%)**") |>
  bold_labels()

```

### Tableau 2.2.1b Prévalence de l'hypertension artérielle par âge et sexe

```{r tab_2_2_1b}
tab <- svyby( ~ hta, ~ agegr + sexe, d, svymean, vartype = c("ci"))
tab[, 3:5] <- round(tab[, 3:5] * 100)
names(tab) <- c('Age', 'Sexe', 'obese', 'lo', 'hi')
tab$gros <- paste0(tab$obese, ' (', tab$lo, ' - ', tab$hi, ')')
names(tab)[6] <- "HTA (IC 95%)"
rownames(tab) <- NULL
tab <- tab[, c(1:2, 6)]
gt::gt(tab, groupname_col = 'Sexe') |> 
 gt::tab_style(
     locations = cells_column_labels(columns = everything()),
     style     = list(
       cell_text(weight = "bold")
     )
   )

```


### Tableau 2.2.2 Facteurs de risque d'HTA (analyse uni- et multivariée, ajustées pour les effets d'échantillonnage)

```{r tab_2_2_2}
d <- survey::svydesign(id = ~ uid,
                  weights = ~ w2,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(obese), .(uid,
                                                  w2,
                                                  gstratum,
                                                  sexe,
                                                  Age = agegr,
                                                  Education = edu,
                                                  obese,
                                                  HTA=hta)]) 

# svymean(~obese, d, deff=T)

t1 <- tbl_uvregression(d,
    method = svyglm,
    label = list(gstratum ~ "Archipel", sexe ~ "Sexe", obese ~ "Obésité"),
    include = c('gstratum', 'sexe', 'Age', 'Education','obese'),
    hide_n = TRUE,
    y = HTA,
    method.args = list(family = quasibinomial),
    exponentiate = TRUE
  ) |>
  modify_header(update = list(estimate ~ "**OR (IC 95%)**")) |>
#  add_q() |>
  modify_footnote(estimate = "OR = rapport de cotes, IC = intervalle de confiance", abbreviation = TRUE) |>
  add_significance_stars(hide_se = TRUE,
                         hide_p = FALSE,
                         pattern = "{p.value}{stars}")

m <-
  svyglm(
    HTA ~ gstratum + sexe + Age + Education + obese,
    design = d,
    family = "quasibinomial"
  )

t2 <- tbl_regression(m,
               label = list(gstratum ~ "Archipel", sexe ~ "Sexe", obese ~ "Obésité"),
               exponentiate = TRUE) |>
  modify_header(update = list(estimate ~ "**aOR (IC 95%)**")) |>
  modify_footnote(estimate = "aOR = rapport de cotes ajusté", abbreviation = TRUE) |>
#  add_global_p() |>
  add_significance_stars(
    hide_se = TRUE,
    hide_p = FALSE,
    pattern = "{p.value}{stars}"
  )
# modify_footnote(everything() ~ NA, abbreviation = TRUE)

tbl_merge(
  tbls        = list(t1, t2),
  tab_spanner = c("**Analyse univariée**", "**Analyse multivariée**")
)

```


## 2.3 Diabète

### Tableau 2.3.1a Prévalence du diabète
```{r tab_2_3_1a}
d <- survey::svydesign(
  id = ~ uid,
  weights = ~ w3,
  strata = ~ gstratum + agegr,
  data = steps[enroll == 1 &
                 !is.na(diabete), .(uid,
                                    w3,
                                    gstratum,
                                    agegr,
                                    bmigr,
                                    sexe,
                                    diabete,
                                    Diabete)]
)

tbl_svysummary(d,
               include = c(Diabete),
               statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Prévalence (IC 95%)**") |>
  bold_labels()
```

### Tableau 2.3.1b Prévalence du diabète par âge et sexe
```{r tab_2_3_1b}
tab <- svyby( ~ diabete, ~ agegr + sexe, d, svymean, vartype = c("ci"))
tab[, 3:5] <- round(tab[, 3:5] * 100)
names(tab) <- c('Age', 'Sexe', 'obese', 'lo', 'hi')
tab$gros <- paste0(tab$obese, ' (', tab$lo, ' - ', tab$hi, ')')
names(tab)[6] <- "Diabète (IC 95%)"
rownames(tab) <- NULL
tab <- tab[, c(1:2, 6)]
gt::gt(tab, groupname_col = 'Sexe') |> 
 gt::tab_style(
     locations = cells_column_labels(columns = everything()),
     style     = list(
       cell_text(weight = "bold")
     )
   )

```

### Tableau 2.3.2 Facteurs de risque du diabète (analyse uni- et multivariée, ajustées pour les effets d'échantillonnage)

```{r tab_2_3_2}
d <- survey::svydesign(id = ~ uid,
                  weights = ~ w3,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(diabete), .(uid,
                                                  w3,
                                                  gstratum,
                                                  sexe,
                                                  Age = agegr,
                                                  Education = edu,
                                                  Obese,
                                                  HTA,
                                                  Diabete)]) 

t1 <- tbl_uvregression(d,
    method = svyglm,
    label = list(gstratum ~ "Archipel", sexe ~ "Sexe", Obese ~ "Obésité"),
    include = c('gstratum', 'sexe', 'Age', 'Education','Obese','HTA'),
    hide_n = TRUE,
    y = Diabete,
    method.args = list(family = quasibinomial),
    exponentiate = TRUE
  ) |>
  modify_header(update = list(estimate ~ "**OR (IC 95%)**")) |>
#  add_q() |>
  modify_footnote(estimate = "OR = rapport de cotes, IC = intervalle de confiance", abbreviation = TRUE) |>
  add_significance_stars(hide_se = TRUE,
                         hide_p = FALSE,
                         pattern = "{p.value}{stars}")

m <-
  svyglm(
    Diabete ~ gstratum + sexe + Age + Education + Obese + HTA,
    design = d,
    family = "quasibinomial"
  )

t2 <- tbl_regression(m,
               label = list(gstratum ~ "Archipel", sexe ~ "Sexe", Obese ~ "Obésité"),
               exponentiate = TRUE) |>
  modify_header(update = list(estimate ~ "**aOR (IC 95%)**")) |>
  modify_footnote(estimate = "aOR = rapport de cotes ajusté", abbreviation = TRUE) |>
#  add_global_p() |>
  add_significance_stars(
    hide_se = TRUE,
    hide_p = FALSE,
    pattern = "{p.value}{stars}"
  )
# modify_footnote(everything() ~ NA, abbreviation = TRUE)

tbl_merge(
  tbls        = list(t1, t2),
  tab_spanner = c("**Analyse univariée**", "**Analyse multivariée**")
)

```
