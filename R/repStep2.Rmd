--- 
title: "Enquête STEP 2019, Polynésie Française"
subtitle: "Step 2, mesures anthropométriques"
output:  
  html_document: 
    mode: selfcontained
    toc: yes 
    tocfloat: true
    number_sections: false
    theme: flatly
fig_width: 12 
fig_caption: FALSE 
lang: fr
--- 


```{r setup, include=FALSE} 
# Chapter 1
# Set options, load data, utility functions 
knitr::opts_chunk$set(
  echo = FALSE,
  results = "asis",
  message = FALSE,
  warning = FALSE
)
library(data.table)
library(here)
library(survey)
library(knitr)
library(kableExtra)
library(gtsummary)
library(flextable)
library(labelled)

load(here('data/report.Rdata'))

theme_gtsummary_language('fr')
theme_gtsummary_journal('jama')

labelled::var_label(steps$bmigr) <- "Corpulence [IMC]"

``` 

Les mesures anthropométriques incluent:

* l'indice de masse corporelle
* le périmètre abdominal
* la tension artérielle

Les tableaux suivants montrent ces indicateurs ajustés pour prendre en compte les effets d'échantillonage (pondération et stratification).


### Tableau 2.1. Corpulence

```{r tab_2_1}
survey::svydesign(id = ~ uid,
                  weights = ~ w1,
                  strata = ~gstratum + agegr,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr), .(uid,
                                                  w1,
                                                  gstratum,
                                                  agegr,
                                                  bmigr)]) |>
  
  tbl_svysummary(include = c(bmigr),
                 statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(stat_0 = "**Pourcentage (IC 95%)**") |>
  bold_labels()

```



### Tableau 2.2. Corpulence par sexe

```{r tab_2_2}

survey::svydesign(id = ~ uid,
                  weights = ~ w1,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr), .(
                                   uid,
                                   w1,
                                   gstratum,
                                   Sexe=sexe,
                                   Age=agegr,
                                   bmigr
                                 )]) |>
  tbl_svysummary(include = c(bmigr),
                 by = Sexe,
                 statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Sexe**",
                stat_1 = "**Femmes**",
                stat_2 = "**Hommes**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  bold_labels() 

```




### Tableau 2.3. Corpulence par groupe d'âge (hommes et femmes)

```{r tab_2_3}
survey::svydesign(id = ~ uid,
                  weights = ~ w1,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr), .(
                                   uid,
                                   w1,
                                   gstratum,
                                   Sexe=sexe,
                                   Age=agegr,
                                   bmigr
                                 )]) |>
  tbl_svysummary(include = c(bmigr),
                 by = Age,
                 statistic = list(all_categorical() ~ "{p}")) |>
  modify_header(label ~ "**Groupe d'âge**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels() 

```

### Tableau 2.4. Corpulence par groupe d'âge (hommes)

```{r tab_2_4}
survey::svydesign(id = ~ uid,
                  weights = ~ w1,
                  strata = ~gstratum + Age,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr) & sex == "M" , .(uid,
                                                                w1,
                                                                gstratum,
                                                                Age = agegr,
                                                                bmigr)]) |>
  tbl_svysummary(
    include = c(bmigr),
    by = Age,
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Groupe d'âge**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels() 

```

### Tableau 2.5. Corpulence par groupe d'âge (femmes)

```{r tab_2_5}
survey::svydesign(id = ~ uid,
                  weights = ~ w1,
                  data = steps[enroll == 1 &
                                 !is.na(bmigr) & sex == "F", .(uid,
                                                               w1,
                                                               gstratum,
                                                               Age = agegr,
                                                               bmigr)]) |>
  tbl_svysummary(
    include = c(bmigr),
    by = Age,
    statistic = list(all_categorical() ~ "{p}")
  ) |>
  modify_header(label ~ "**Groupe d'âge**") |>
  add_ci(
    pattern = "{stat} ({ci})",
    statistic = list(all_categorical() ~ "{conf.low} - {conf.high}")
  )  |>
  modify_header(all_stat_cols() ~ "**{level}**") |>
  bold_labels()

```


### Tableau 2.6. Facteurs de risque d'obésité (analyse uni- et multivariée, ajustées pour les effets d'échantillonnage)

```{r tab_2_6}
d <- survey::svydesign(id = ~ uid,
                  weights = ~ w1,
                  data = steps[enroll == 1 &
                                 !is.na(obese), .(uid,
                                                  w1,
                                                  gstratum,
                                                  sexe,
                                                  Age = agegr,
                                                  Education = edu,
                                                  obese)]) 



t1 <- tbl_uvregression(d,
    method = svyglm,
    label = list(gstratum ~ "Archipel", sexe ~ "Sexe"),
    include = c('gstratum', 'sexe', 'Age', 'Education'),
    hide_n = TRUE,
    y = obese,
    method.args = list(family = quasibinomial),
    exponentiate = TRUE
  ) |>
  modify_header(update = list(estimate ~ "**OR (IC 95%)**")) |>
#  add_q() |>
  modify_footnote(estimate = "OR = rapport de cotes, IC = intervalle de confiance", abbreviation = TRUE) |>
  add_significance_stars(hide_se = TRUE,
                         hide_p = FALSE,
                         pattern = "{p.value}{stars}")

m <-
  svyglm(
    obese ~ gstratum + sexe + Age + Education,
    design = d,
    family = "quasibinomial"
  )

t2 <- tbl_regression(m,
               label = list(gstratum ~ "Archipel", sexe ~ "Sexe"),
               exponentiate = TRUE) |>
  modify_header(update = list(estimate ~ "**aOR (IC 95%)**")) |>
  modify_footnote(estimate = "aOR = rapport de cotes ajusté", abbreviation = TRUE) |>
#  add_global_p() |>
  add_significance_stars(
    hide_se = TRUE,
    hide_p = FALSE,
    pattern = "{p.value}{stars}"
  )
  
# modify_footnote(everything() ~ NA, abbreviation = TRUE)

tbl_merge(
    tbls        = list(t1, t2),
    tab_spanner = c("**Analyse univariée**", "**Analyse multivariée**")
  )

```

